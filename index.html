```html
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Men√∫ Semanal Autom√°tico</title>

  <style>
    /* ==========================================================================
      MEN√ö SEMANAL ‚Äî UI + interacci√≥n (sin cambiar reglas / data)
      - Mantengo tu l√≥gica de generaci√≥n, storage y reglas:
        (prote√≠na por categor√≠a no repetida entre bloques, 1 cocido + 1 crudo, etc.)
      - Solo cambio presentaci√≥n y a√±ado la interacci√≥n que muestran tus dise√±os:
        1) Pantalla inicial con bot√≥n grande "Generar men√∫"
        2) Loader pantalla completa al generar / rehacer todo
        3) Vista "Men√∫ generado" con cards por bloque + "Copiar men√∫"
        4) Modal de "Rehacer platillo" con 3 opciones (guisado / guarnici√≥n 1 / guarnici√≥n 2)
        5) Loader sobre opci√≥n seleccionada + confirmaci√≥n "¬°Platillo actualizado!"
      ========================================================================== */

    :root{
      --bg:#ffffff;
      --text:#0b0b0f;
      --muted:#6b7280;

      --border:#e5e7eb;
      --card:#ffffff;
      --cardSoft:#f8fafc;

      --blue:#0b63ff;
      --blueSoft:rgba(11,99,255,.10);

      --shadow:0 10px 30px rgba(15,23,42,.10);

      --r-xl:22px;
      --r-lg:18px;
      --r-md:14px;

      --container: 980px;

      --h1: clamp(44px, 7vw, 72px);
      --h2: clamp(26px, 4vw, 34px);
      --p1: clamp(18px, 3vw, 26px);
      --p2: 20px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text",
        Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .page{
      max-width: var(--container);
      margin: 0 auto;
      padding: 26px 18px 70px;
    }

    .title{
      margin:0;
      font-size: var(--h1);
      font-weight: 900;
      line-height: 0.95;
      letter-spacing: -0.02em;
    }

    .subtitle{
      margin: 16px 0 0;
      font-size: var(--p1);
      color: var(--text);
      font-weight: 650;
      letter-spacing: -0.01em;
    }

    /* Card container (como en imagen 1 y 3/4) */
    .shell{
      margin-top: 26px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: var(--r-xl);
      padding: 22px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    /* Buttons */
    .btn{
      border: 1px solid transparent;
      background: var(--blue);
      color:#fff;
      border-radius: 18px;
      padding: 18px 18px;
      font-size: 22px;
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      -webkit-tap-highlight-color: transparent;
      transition: transform .05s ease, opacity .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.985); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn-ghost{
      background: #fff;
      color: var(--blue);
      border-color: var(--border);
    }
    .btn-ghost:hover{ border-color: rgba(11,99,255,.35); }

    .btn-wide{ width: 100%; }

    /* Initial area */
    .centerRow{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 10px 0 0;
    }
    .bigCTA{
      width: min(640px, 100%);
      border-radius: 28px;
      padding: 26px 22px;
      font-size: 30px;
      font-weight: 900;
    }

    /* Header row inside "Men√∫ generado" */
    .menuHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 18px;
    }
    .menuHeader h2{
      margin:0;
      font-size: var(--h2);
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    .copyBtn{
      font-size: 22px;
      padding: 14px 16px;
      border-radius: 16px;
      display:inline-flex;
      gap:10px;
    }
    .copyIcon{
      width: 22px;
      height: 22px;
      display:inline-block;
      border: 2px solid currentColor;
      border-radius: 4px;
      position:relative;
      transform: translateY(1px);
    }
    .copyIcon::after{
      content:"";
      position:absolute;
      width: 22px;
      height: 22px;
      border: 2px solid currentColor;
      border-radius: 4px;
      left: 7px;
      top: -7px;
      background: transparent;
    }

    /* Blocks (cards por secci√≥n) */
    .blocks{
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    .blockCard{
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: var(--card);
      padding: 18px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }

    .blockTitle{
      margin:0 0 10px;
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    .lines{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 4px 0 14px;
      font-size: 24px;
    }

    .line{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      line-height: 1.25;
    }
    .emoji{
      width: 28px;
      flex: 0 0 28px;
      text-align:center;
      transform: translateY(2px);
    }

    .rehacerWrap{
      margin-top: 10px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: var(--r-lg);
      padding: 14px;
    }
    .rehacerBtn{
      width: 100%;
      background: #fff;
      color: var(--blue);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 16px;
      font-size: 26px;
      font-weight: 800;
    }

    /* "Otras opciones" */
    .other{
      margin-top: 18px;
      padding-top: 18px;
      border-top: 1px solid var(--border);
    }
    .otherTitle{
      margin:0 0 14px;
      font-size: 28px;
      font-weight: 900;
      color: #9aa3b2;
      letter-spacing: -0.02em;
    }

    .redoAllBtn{
      width: 100%;
      padding: 18px 16px;
      font-size: 26px;
      font-weight: 900;
      border-radius: 18px;
      background:#fff;
      color: var(--blue);
      border: 1px solid var(--border);
    }

    /* Loader full screen (imagen 2) */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.92);
      display:none;
      z-index: 50;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }
    .overlay.show{ display:flex; }

    .loaderBox{
      width: min(520px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 18px;
    }

    .spin{
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 7px solid rgba(11,99,255,.18);
      border-top-color: var(--blue);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .loaderText{
      font-size: 34px;
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    /* Modal (imagen 5/6/7) */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      z-index: 60;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modalBackdrop.show{ display:flex; }

    .modal{
      width: min(760px, 100%);
      background: #fff;
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }

    .modalTop{
      padding: 22px 22px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 16px;
    }

    .modalTitle{
      margin:0;
      font-size: 34px;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.05;
    }

    .closeX{
      border:none;
      background:transparent;
      color: var(--blue);
      cursor:pointer;
      font-size: 34px;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 12px;
    }
    .closeX:active{ background: var(--tap); }

    .modalBody{
      padding: 10px 22px 22px;
    }

    .modalBlockTitle{
      margin: 18px 0 10px;
      font-size: 26px;
      font-weight: 900;
    }

    .modalLines{
      font-size: 24px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .modalActions{
      display:flex;
      flex-direction:column;
      gap: 14px;
      padding-top: 8px;
    }

    .modalActionBtn{
      width: 100%;
      background: #fff;
      color: var(--blue);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 16px;
      font-size: 26px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
    }

    .miniSpinner{
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid rgba(11,99,255,.18);
      border-top-color: var(--blue);
      animation: spin .9s linear infinite;
      display:none;
    }
    .modalActionBtn.loading .miniSpinner{ display:inline-block; }
    .modalActionBtn.loading .label{ opacity:.7; }

    /* Confirmaci√≥n (imagen 7) */
    .confirmView{
      display:none;
      padding: 34px 22px 30px;
      text-align:center;
    }
    .confirmView.show{ display:block; }

    .confirmTitle{
      margin:0;
      font-size: 34px;
      font-weight: 900;
      text-align:left;
      padding: 0 0 18px;
    }
    .checkBig{
      font-size: 86px;
      font-weight: 900;
      margin: 12px 0 0;
    }

    /* Util */
    .hide{ display:none !important; }

    /* Responsive tweaks */
    @media (max-width: 520px){
      .bigCTA{ font-size: 26px; padding: 22px 18px; }
      .menuHeader h2{ font-size: 28px; }
      .copyBtn{ font-size: 20px; }
      .blockTitle{ font-size: 24px; }
      .lines{ font-size: 22px; }
      .rehacerBtn{ font-size: 22px; }
      .otherTitle{ font-size: 24px; }
      .redoAllBtn{ font-size: 22px; }
      .modalTitle{ font-size: 28px; }
      .modalActionBtn{ font-size: 22px; }
    }
  </style>
</head>

<body>
  <!-- Loader global (Imagen 2) -->
  <div class="overlay" id="globalLoader" aria-hidden="true">
    <div class="loaderBox">
      <div class="spin" aria-hidden="true"></div>
      <div class="loaderText" id="globalLoaderText">Generando men√∫...</div>
    </div>
  </div>

  <!-- Modal rehacer (Imagen 5/6/7) -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalTop">
        <h3 class="modalTitle" id="modalTitle">¬øQu√© platillo deseas rehacer?</h3>
        <button class="closeX" id="modalClose" aria-label="Cerrar">√ó</button>
      </div>

      <div class="modalBody">
        <!-- Vista normal (opciones) -->
        <div id="modalContent">
          <div class="modalBlockTitle" id="modalBlockHeading">‚Äî</div>
          <div class="modalLines" id="modalLines"></div>

          <div class="modalActions">
            <button class="modalActionBtn" id="btnRedoProtein">
              <span class="miniSpinner" aria-hidden="true"></span>
              <span class="label">‚Üª Rehacer guisado</span>
            </button>
            <button class="modalActionBtn" id="btnRedoCooked">
              <span class="miniSpinner" aria-hidden="true"></span>
              <span class="label">‚Üª Rehacer guarnici√≥n 1</span>
            </button>
            <button class="modalActionBtn" id="btnRedoRaw">
              <span class="miniSpinner" aria-hidden="true"></span>
              <span class="label">‚Üª Rehacer guarnici√≥n 2</span>
            </button>
          </div>
        </div>

        <!-- Vista confirmaci√≥n (Imagen 7) -->
        <div class="confirmView" id="modalConfirm">
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
            <h3 class="confirmTitle">¬°Platillo actualizado!</h3>
            <button class="closeX" id="modalClose2" aria-label="Cerrar">√ó</button>
          </div>
          <div class="checkBig">‚úì</div>
        </div>
      </div>
    </div>
  </div>

  <main class="page">
    <h1 class="title">Men√∫ Semanal<br/>Autom√°tico</h1>
    <p class="subtitle" id="weekLabel">Semana ‚Äî</p>

    <section class="shell">
      <!-- Pantalla inicial (Imagen 1): solo bot√≥n grande -->
      <div id="emptyState">
        <div class="centerRow">
          <button class="btn bigCTA" id="btnGenerate">Generar men√∫</button>
        </div>
      </div>

      <!-- Men√∫ generado (Imagen 3/4) -->
      <div id="menuState" class="hide">
        <div class="menuHeader">
          <h2>Men√∫ generado</h2>
          <button class="btn btn-ghost copyBtn" id="btnCopy" title="Copiar men√∫">
            <span class="copyIcon" aria-hidden="true"></span>
            Copiar men√∫
          </button>
        </div>

        <div class="blocks" id="menuSections"></div>

        <div class="other">
          <div class="otherTitle">Otras opciones</div>
          <button class="btn btn-ghost redoAllBtn" id="btnRedoAll">Rehacer todo</button>
        </div>
      </div>
    </section>
  </main>

<script>
/* ==========================================================================
  IMPORTANTE:
  - Reutilizo tus datos y reglas.
  - Mantengo el STORAGE_KEY y el esquema blocks: { LM:{protein,proteinCat,sides[2]}, ... }
  - Solo cambi√© el render (ya no es un textarea) y agregu√© modal + loaders.
========================================================================== */

// =====================
//  PROTE√çNAS (tuyas)
//  Regla: categor√≠a NO se repite entre LM / MJ / V
// =====================
const PROTEINS = [
  // Pollo
  { name: "Muslo de pollo asado", cat: "pollo" },
  { name: "Pollo a la plancha", cat: "pollo" },
  { name: "Pollo en salsa verde", cat: "pollo" },
  { name: "Pollo con salsa de soya y lim√≥n", cat: "pollo" },
  { name: "Pollo al grat√≠n con chorizo", cat: "pollo" },
  { name: "Fajitas de pollo asadas", cat: "pollo" },
  { name: "Tinga de pollo", cat: "pollo" },
  { name: "Pechuga de pollo encebollada", cat: "pollo" },
  { name: "Enchiladas suizas con pollo", cat: "pollo" },
  { name: "Tacos dorados de pollo", cat: "pollo" },

  // Res
  { name: "Entrecot", cat: "res" },
  { name: "Picadillo de res", cat: "res" },
  { name: "Alb√≥ndigas de res", cat: "res" },
  { name: "Salpic√≥n de res", cat: "res" },

  // Cerdo
  { name: "Cerdo en salsa verde", cat: "cerdo" },

  // Pescado / Mariscos
  { name: "Salm√≥n asado", cat: "pescado" },
  { name: "Ceviche de at√∫n", cat: "pescado" },
  { name: "Medall√≥n de at√∫n", cat: "pescado" },
  { name: "At√∫n tipo bacalao", cat: "pescado" },

  // Otras
  { name: "Tortitas de papa con at√∫n", cat: "otras" },
  { name: "Pastel de papa con queso y jam√≥n", cat: "otras" },
  { name: "Calabazas partidas a la mitad con carne y queso", cat: "otras" }
];

// =====================
//  COMPLEMENTOS (tuyos)
//  Regla: 1 cocido + 1 crudo por bloque
// =====================

// Cocidos
const COOKED_SIDES = [
  { name: "Sopa de fideo", cat: "cocido_sopa" },
  { name: "Sopa de verduras", cat: "cocido_sopa" },
  { name: "Sopa aguada", cat: "cocido_sopa" },
  { name: "Sopa de tortilla", cat: "cocido_sopa" },
  { name: "Crema de verdura", cat: "cocido_sopa" },
  { name: "Caldo de verduras", cat: "cocido_sopa" },

  { name: "Sopa de lentejas", cat: "cocido_leguminosa" },
  { name: "Frijoles de la olla", cat: "cocido_leguminosa" },
  { name: "Sopa de alubias", cat: "cocido_leguminosa" },
  { name: "Sopa de garbanzos", cat: "cocido_leguminosa" },

  { name: "Arroz", cat: "cocido_carbo" },
  { name: "Quinoa", cat: "cocido_carbo" },
  { name: "Spaghetti blanco", cat: "cocido_carbo" },
  { name: "Spaghetti al ajo", cat: "cocido_carbo" },
  { name: "Spaghetti rojo", cat: "cocido_carbo" },

  { name: "Papas asadas", cat: "cocido_papa" },
  { name: "Papas al horno", cat: "cocido_papa" },
  { name: "Pur√© de papa", cat: "cocido_papa" },

  { name: "Verduras al vapor", cat: "cocido_verdura" },
  { name: "Verduras asadas", cat: "cocido_verdura" },
  { name: "Verduras salteadas", cat: "cocido_verdura" },
];

// Crudos
const RAW_SIDES = [
  { name: "Ensalada verde", cat: "crudo_ensalada" },
  { name: "Ensalada de lechuga", cat: "crudo_ensalada" },
  { name: "Ensalada de lechuga con espinaca", cat: "crudo_ensalada" },
  { name: "Ensalada de nopales", cat: "crudo_ensalada" },
  { name: "Ensalada de jitomate", cat: "crudo_ensalada" },
  { name: "Ensalada de jitomate con lechuga", cat: "crudo_ensalada" },
  { name: "Verduras crudas", cat: "crudo_verdura" },
  { name: "Ensalada con aguacate", cat: "crudo_ensalada" },
  { name: "Ensalada verde con semillas", cat: "crudo_ensalada" },
  { name: "Guacamole sin lechuga revuelta", cat: "crudo_extra" },
  { name: "Ensalada de ejotes con esp√°rragos", cat: "crudo_ensalada" },
  { name: "Ensalada con germinado de lentejas", cat: "crudo_ensalada" },
];

// =====================
//  Constantes (tuyas)
// =====================
const STORAGE_KEY = "menu_week_blocks_v9";
const BLOCKS = [
  { key: "LM", title: "Lunes y Martes" },
  { key: "MJ", title: "Mi√©rcoles y Jueves" },
  { key: "V",  title: "Viernes" }
];

// =====================
//  DOM refs
// =====================
const els = {
  weekLabel: document.getElementById("weekLabel"),
  emptyState: document.getElementById("emptyState"),
  menuState: document.getElementById("menuState"),
  menuSections: document.getElementById("menuSections"),

  btnGenerate: document.getElementById("btnGenerate"),
  btnRedoAll: document.getElementById("btnRedoAll"),
  btnCopy: document.getElementById("btnCopy"),

  globalLoader: document.getElementById("globalLoader"),
  globalLoaderText: document.getElementById("globalLoaderText"),

  modalBackdrop: document.getElementById("modalBackdrop"),
  modalClose: document.getElementById("modalClose"),
  modalClose2: document.getElementById("modalClose2"),
  modalTitle: document.getElementById("modalTitle"),
  modalBlockHeading: document.getElementById("modalBlockHeading"),
  modalLines: document.getElementById("modalLines"),

  modalContent: document.getElementById("modalContent"),
  modalConfirm: document.getElementById("modalConfirm"),

  btnRedoProtein: document.getElementById("btnRedoProtein"),
  btnRedoCooked: document.getElementById("btnRedoCooked"),
  btnRedoRaw: document.getElementById("btnRedoRaw"),
};

// Estado UI
let currentMeta = null;
let currentSaved = null;
let modalBlockKey = null;

// =====================
//  Fechas (tuyas)
// =====================
const MONTHS_ES = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

function startOfWeekMonday(date){
  const d = new Date(date);
  d.setHours(0,0,0,0);
  const day = d.getDay(); // Dom=0..Sab=6
  const diffToMonday = (day === 0) ? -6 : (1 - day);
  d.setDate(d.getDate() + diffToMonday);
  return d;
}
function addDays(date, days){
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}
function targetWeekRange(now = new Date()){
  const base = new Date(now);
  if(base.getDay() === 6){ base.setDate(base.getDate() + 7); } // s√°bado => siguiente semana
  const monday = startOfWeekMonday(base);
  const friday = addDays(monday, 4);
  return { monday, friday };
}
function formatRangeLabel(monday, friday){
  const d1 = monday.getDate();
  const d2 = friday.getDate();
  const m1 = MONTHS_ES[monday.getMonth()];
  const m2 = MONTHS_ES[friday.getMonth()];
  const year = monday.getFullYear();
  if(monday.getMonth() === friday.getMonth()){
    return `Semana del ${d1} a ${d2} de ${m1} ${year}`;
  }
  return `Semana del ${d1} de ${m1} a ${d2} de ${m2} ${year}`;
}
function currentTargetMeta(){
  const { monday, friday } = targetWeekRange(new Date());
  const key = `${monday.getFullYear()}-${String(monday.getMonth()+1).padStart(2,'0')}-${String(monday.getDate()).padStart(2,'0')}`;
  return { key, monday, friday, label: formatRangeLabel(monday, friday), year: monday.getFullYear() };
}

// =====================
//  RNG / helpers (tuyos)
// =====================
function seededRng(seed){
  let x = seed >>> 0;
  return function(){
    x = (1664525 * x + 1013904223) >>> 0;
    return x / 4294967296;
  };
}
function hashStringToUint(str){
  let h = 2166136261 >>> 0;
  for(let i=0; i<str.length; i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function pickOne(arr, rng){
  return arr[Math.floor(rng() * arr.length)];
}
function shuffleInPlace(arr, rng){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(rng() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function proteinsByCategory(){
  const map = new Map();
  for(const p of PROTEINS){
    if(!map.has(p.cat)) map.set(p.cat, []);
    map.get(p.cat).push(p);
  }
  return map;
}
function pickCookedAndRaw(rng){
  const cooked = pickOne(COOKED_SIDES, rng);
  let raw = pickOne(RAW_SIDES, rng);
  let guard = 0;
  while(raw.cat === cooked.cat && guard++ < 20){
    raw = pickOne(RAW_SIDES, rng);
  }
  return [cooked.name, raw.name];
}

// =====================
//  Storage (tuyo)
// =====================
function loadSaved(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function save(meta, blocks){
  const obj = {
    meta: { key: meta.key, label: meta.label, year: meta.year },
    blocks,
    at: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  return obj;
}
function isSameMeta(savedMeta, meta){
  return savedMeta && meta && savedMeta.key === meta.key;
}

// =====================
//  Generator (tuyo)
// =====================
function makeSeed(meta, salt=0){
  const base = hashStringToUint(meta.key);
  return (base * 31 + (salt >>> 0)) >>> 0;
}
function generateAllBlocksUniqueProteinCats(meta, salt=0){
  const rng = seededRng(makeSeed(meta, salt));
  const pMap = proteinsByCategory();
  const pCats = Array.from(pMap.keys());
  const chosenProteinCats = shuffleInPlace([...pCats], rng).slice(0, BLOCKS.length);

  const blocks = {};
  for(let i = 0; i < BLOCKS.length; i++){
    const b = BLOCKS[i];
    const cat = chosenProteinCats[i];
    const proteinObj = pickOne(pMap.get(cat), rng);
    const sides = pickCookedAndRaw(rng);
    blocks[b.key] = { protein: proteinObj.name, proteinCat: cat, sides };
  }
  return blocks;
}
function regenerateSingleBlockKeepingUniqueProteinCats(meta, existingBlocks, blockKey){
  const usedCats = new Set();
  for(const k of Object.keys(existingBlocks)){
    if(k !== blockKey && existingBlocks[k]?.proteinCat){
      usedCats.add(existingBlocks[k].proteinCat);
    }
  }

  const pMap = proteinsByCategory();
  let availableCats = Array.from(pMap.keys()).filter(c => !usedCats.has(c));
  if(!availableCats.length) availableCats = Array.from(pMap.keys());

  const rng = seededRng(makeSeed(meta, Date.now() & 0xffffffff));
  availableCats = shuffleInPlace(availableCats, rng);

  const chosenCat = availableCats[0];
  const proteinObj = pickOne(pMap.get(chosenCat), rng);
  const sides = pickCookedAndRaw(rng);

  return { protein: proteinObj.name, proteinCat: chosenCat, sides };
}

/* ==========================================================================
  NUEVO (UI expected): rehacer por componente dentro del bloque
  - NO cambia reglas: prote√≠na sigue respetando "cat √∫nica entre bloques".
  - Guarnici√≥n 1 = cocido (COOKED_SIDES)
  - Guarnici√≥n 2 = crudo (RAW_SIDES)
========================================================================== */
function regenerateProteinOnlyKeepingUniqueCats(meta, existingBlocks, blockKey){
  const usedCats = new Set();
  for(const k of Object.keys(existingBlocks)){
    if(k !== blockKey && existingBlocks[k]?.proteinCat) usedCats.add(existingBlocks[k].proteinCat);
  }
  const pMap = proteinsByCategory();
  let availableCats = Array.from(pMap.keys()).filter(c => !usedCats.has(c));
  if(!availableCats.length) availableCats = Array.from(pMap.keys());

  const rng = seededRng(makeSeed(meta, Date.now() & 0xffffffff));
  availableCats = shuffleInPlace(availableCats, rng);

  const chosenCat = availableCats[0];
  const proteinObj = pickOne(pMap.get(chosenCat), rng);

  const prev = existingBlocks[blockKey];
  return { ...prev, protein: proteinObj.name, proteinCat: chosenCat };
}
function regenerateCookedOnly(meta, existingBlocks, blockKey){
  const rng = seededRng(makeSeed(meta, Date.now() & 0xffffffff));
  const prev = existingBlocks[blockKey];
  const cooked = pickOne(COOKED_SIDES, rng).name;
  return { ...prev, sides: [cooked, prev.sides[1]] };
}
function regenerateRawOnly(meta, existingBlocks, blockKey){
  const rng = seededRng(makeSeed(meta, Date.now() & 0xffffffff));
  const prev = existingBlocks[blockKey];
  const raw = pickOne(RAW_SIDES, rng).name;
  return { ...prev, sides: [prev.sides[0], raw] };
}

// =====================
//  Render (nuevo)
// =====================
function setWeekLabel(meta){
  els.weekLabel.textContent = meta.label;
}

function showEmptyState(){
  els.emptyState.classList.remove("hide");
  els.menuState.classList.add("hide");
}
function showMenuState(){
  els.emptyState.classList.add("hide");
  els.menuState.classList.remove("hide");
}

function blockLineRow(emoji, text){
  const div = document.createElement("div");
  div.className = "line";
  div.innerHTML = `<div class="emoji">${emoji}</div><div>${escapeHtml(text)}</div>`;
  return div;
}

function renderBlocks(blocks){
  els.menuSections.innerHTML = "";
  for(const b of BLOCKS){
    const data = blocks[b.key];
    if(!data) continue;

    const card = document.createElement("div");
    card.className = "blockCard";

    const title = document.createElement("h3");
    title.className = "blockTitle";
    title.textContent = `${b.title}:`;
    card.appendChild(title);

    const lines = document.createElement("div");
    lines.className = "lines";
    // En tu dise√±o: 3 l√≠neas con emojis. Aqu√≠:
    // 1) üçó = prote√≠na (guisado)
    // 2) üç≤ = guarnici√≥n 1 (cocido)
    // 3) ü•ó = guarnici√≥n 2 (crudo)
    lines.appendChild(blockLineRow("üçó", data.protein));
    lines.appendChild(blockLineRow("üç≤", data.sides?.[0] ?? "‚Äî"));
    lines.appendChild(blockLineRow("ü•ó", data.sides?.[1] ?? "‚Äî"));
    card.appendChild(lines);

    const wrap = document.createElement("div");
    wrap.className = "rehacerWrap";

    const btn = document.createElement("button");
    btn.className = "btn rehacerBtn";
    btn.type = "button";
    btn.textContent = "‚Üª Rehacer platillo";
    btn.addEventListener("click", () => openModal(b.key));
    wrap.appendChild(btn);

    card.appendChild(wrap);

    els.menuSections.appendChild(card);
  }
}

function renderAll(meta, saved){
  setWeekLabel(meta);
  if(saved && isSameMeta(saved.meta, meta) && saved.blocks && Object.keys(saved.blocks).length){
    renderBlocks(saved.blocks);
    showMenuState();
  }else{
    showEmptyState();
  }
}

// Texto para copiar (mantiene tu idea: texto completo del men√∫)
function formatMenuTextForCopy(meta, blocks){
  const lines = [];
  lines.push(`MEN√ö ‚Äî ${meta.label}`);
  lines.push("‚Äî".repeat(40));
  for(const b of BLOCKS){
    const c = blocks?.[b.key];
    if(!c) continue;
    lines.push(`${b.title}:`);
    lines.push(`- Guisado: ${c.protein}`);
    lines.push(`- Guarnici√≥n 1: ${c.sides?.[0] ?? "‚Äî"}`);
    lines.push(`- Guarnici√≥n 2: ${c.sides?.[1] ?? "‚Äî"}`);
    lines.push("");
  }
  return lines.join("\n").trim();
}

// =====================
//  Loader global (imagen 2)
// =====================
function showGlobalLoader(text="Generando men√∫..."){
  els.globalLoaderText.textContent = text;
  els.globalLoader.classList.add("show");
  els.globalLoader.setAttribute("aria-hidden", "false");
}
function hideGlobalLoader(){
  els.globalLoader.classList.remove("show");
  els.globalLoader.setAttribute("aria-hidden", "true");
}

// =====================
//  Modal (imagen 5/6/7)
// =====================
function openModal(blockKey){
  modalBlockKey = blockKey;

  // Reset modal views
  els.modalConfirm.classList.remove("show");
  els.modalContent.classList.remove("hide");

  // Reset buttons loading/disabled
  setModalButtonsEnabled(true);
  setModalButtonLoading(null);

  const blockTitle = BLOCKS.find(b => b.key === blockKey)?.title ?? "‚Äî";
  const data = currentSaved?.blocks?.[blockKey];

  els.modalTitle.textContent = `¬øQu√© platillo deseas rehacer del ${blockTitle}?`;
  els.modalBlockHeading.textContent = `${blockTitle}:`;

  // Lines
  els.modalLines.innerHTML = "";
  if(data){
    els.modalLines.appendChild(blockLineRow("üçó", data.protein));
    els.modalLines.appendChild(blockLineRow("üç≤", data.sides?.[0] ?? "‚Äî"));
    els.modalLines.appendChild(blockLineRow("ü•ó", data.sides?.[1] ?? "‚Äî"));
  }

  els.modalBackdrop.classList.add("show");
  els.modalBackdrop.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
function closeModal(){
  els.modalBackdrop.classList.remove("show");
  els.modalBackdrop.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  modalBlockKey = null;
}

function setModalButtonsEnabled(enabled){
  els.btnRedoProtein.disabled = !enabled;
  els.btnRedoCooked.disabled = !enabled;
  els.btnRedoRaw.disabled = !enabled;
}
function setModalButtonLoading(which /* "protein"|"cooked"|"raw"|null */){
  const map = {
    protein: els.btnRedoProtein,
    cooked: els.btnRedoCooked,
    raw: els.btnRedoRaw
  };
  for(const k of Object.keys(map)){
    map[k].classList.toggle("loading", k === which);
  }
}
function showModalConfirmation(){
  els.modalContent.classList.add("hide");
  els.modalConfirm.classList.add("show");
}

// =====================
//  Actions (con loaders)
// =====================
function ensureMenuLoaded(){
  currentMeta = currentTargetMeta();
  setWeekLabel(currentMeta);

  const saved = loadSaved();
  const hasMenu = !!(saved && isSameMeta(saved.meta, currentMeta) && saved.blocks && Object.keys(saved.blocks).length);

  currentSaved = hasMenu ? saved : null;
  renderAll(currentMeta, currentSaved);
}

function actionGenerate(){
  // Loader como imagen 2
  showGlobalLoader("Generando men√∫...");
  // Simulaci√≥n breve de carga (para UX) sin afectar l√≥gica
  setTimeout(() => {
    const meta = currentTargetMeta();
    const saved = loadSaved();
    const hasMenu = !!(saved && isSameMeta(saved.meta, meta) && saved.blocks && Object.keys(saved.blocks).length);

    if(hasMenu){
      currentMeta = meta;
      currentSaved = saved;
      renderAll(meta, saved);
      hideGlobalLoader();
      return;
    }

    const blocks = generateAllBlocksUniqueProteinCats(meta, 0);
    const obj = save(meta, blocks);

    currentMeta = meta;
    currentSaved = obj;

    renderAll(meta, obj);
    hideGlobalLoader();
  }, 650);
}

function actionRedoAll(){
  if(!currentSaved) return;

  showGlobalLoader("Generando men√∫...");
  setTimeout(() => {
    const meta = currentTargetMeta();
    const salt = Date.now() & 0xffffffff;
    const blocks = generateAllBlocksUniqueProteinCats(meta, salt);
    const obj = save(meta, blocks);

    currentMeta = meta;
    currentSaved = obj;

    renderAll(meta, obj);
    hideGlobalLoader();
  }, 650);
}

function actionRedoModal(which){
  if(!modalBlockKey || !currentSaved) return;

  // UX como imagen 6: loader sobre opci√≥n seleccionada + bloquear botones
  setModalButtonsEnabled(false);
  setModalButtonLoading(which);

  setTimeout(() => {
    const meta = currentTargetMeta();
    const blocks = { ...currentSaved.blocks };

    if(which === "protein"){
      blocks[modalBlockKey] = regenerateProteinOnlyKeepingUniqueCats(meta, blocks, modalBlockKey);
    }else if(which === "cooked"){
      blocks[modalBlockKey] = regenerateCookedOnly(meta, blocks, modalBlockKey);
    }else if(which === "raw"){
      blocks[modalBlockKey] = regenerateRawOnly(meta, blocks, modalBlockKey);
    }

    const obj = save(meta, blocks);

    // Reflejar cambio en tabla (imagen 3)
    currentMeta = meta;
    currentSaved = obj;
    renderAll(meta, obj);

    // Mostrar confirmaci√≥n (imagen 7)
    showModalConfirmation();
  }, 700);
}

async function copyToClipboard(){
  if(!currentSaved) return;
  const text = formatMenuTextForCopy(currentMeta, currentSaved.blocks);

  try{
    await navigator.clipboard.writeText(text);
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }

  // Mini feedback visual: cambia texto un momento
  const prev = els.btnCopy.textContent;
  els.btnCopy.innerHTML = `<span class="copyIcon" aria-hidden="true"></span> Copiado ‚úì`;
  setTimeout(() => {
    els.btnCopy.innerHTML = `<span class="copyIcon" aria-hidden="true"></span> Copiar men√∫`;
  }, 900);
}

// =====================
//  Utilities
// =====================
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// =====================
//  Wire
// =====================
els.btnGenerate.addEventListener("click", actionGenerate);
els.btnRedoAll.addEventListener("click", actionRedoAll);
els.btnCopy.addEventListener("click", copyToClipboard);

els.modalClose.addEventListener("click", closeModal);
els.modalClose2.addEventListener("click", closeModal);
els.modalBackdrop.addEventListener("click", (e) => {
  if(e.target === els.modalBackdrop) closeModal();
});

els.btnRedoProtein.addEventListener("click", () => actionRedoModal("protein"));
els.btnRedoCooked.addEventListener("click", () => actionRedoModal("cooked"));
els.btnRedoRaw.addEventListener("click", () => actionRedoModal("raw"));

// Init
ensureMenuLoaded();
</script>
</body>
</html>
```
