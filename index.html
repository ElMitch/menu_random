<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Men√∫ semanal (Prote√≠na + Complementos)</title>
  <style>
    :root{
      --bg:#0b0f0d;
      --card:#0f1713;
      --text:#c8ffe0;
      --muted:#7bd3a3;
      --accent:#00ff66;
      --border: rgba(0,255,102,.22);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%; margin:0; background:radial-gradient(1200px 700px at 20% 0%, rgba(0,255,102,.08), transparent 55%) , var(--bg); color:var(--text);}
    .wrap{min-height:100%; display:flex; align-items:center; justify-content:center; padding:20px;}
    .card{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(0,255,102,.06), transparent 35%), var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow: var(--shadow);
      padding:18px 18px 14px;
    }
    header{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;}
    h1{margin:0; font-family:var(--sans); font-size:20px; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-family:var(--sans); font-size:13px; line-height:1.4;}
    .badge{
      font-family:var(--mono);
      font-size:12px;
      color:var(--accent);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,255,102,.04);
      white-space:nowrap;
    }
    .grid{display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px;}
    @media (min-width: 900px){
      .grid{grid-template-columns: 1.2fr .8fr;}
    }
    .panel{
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      padding:14px;
      background:rgba(255,255,255,.02);
    }
    .panel h2{
      margin:0 0 10px;
      font-family:var(--sans);
      font-size:15px;
      color:#eafff4;
    }
    .menuText{
      font-family:var(--mono);
      font-size:13px;
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(0,255,102,.22);
      background:rgba(0,0,0,.25);
      min-height: 320px;
    }
    .btnRow{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;}
    button, a.btn{
      appearance:none;
      border:1px solid rgba(0,255,102,.28);
      background:rgba(0,255,102,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-family:var(--sans);
      font-size:13px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:hover, a.btn:hover{background:rgba(0,255,102,.10);}
    button:active, a.btn:active{transform: translateY(1px);}
    .ghost{border-color: rgba(255,255,255,.10); background: rgba(255,255,255,.03);}
    .danger{border-color: rgba(255,80,80,.35); background: rgba(255,80,80,.06);}
    .ok{color: var(--accent);}
    .small{font-size:12px; color:var(--muted); font-family:var(--sans); margin-top:8px;}
    .list{
      font-family:var(--sans);
      font-size:13px;
      color:#dfffee;
      line-height:1.5;
    }
    .list code{font-family:var(--mono); color:var(--accent); font-size:12px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      padding:6px 10px;
      font-family:var(--mono);
      font-size:12px;
      color:#dfffee;
      background:rgba(255,255,255,.03);
      margin:4px 6px 0 0;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div>
        <h1>Men√∫ semanal autom√°tico</h1>
        <p class="sub">
          Genera 3 combinaciones: <b>Lunes-Martes</b>, <b>Mi√©rcoles-Jueves</b>, <b>Viernes</b>.
          Cada combinaci√≥n = <b>1 prote√≠na</b> + <b>2 complementos</b>. Se guarda toda la semana.
        </p>
      </div>
      <div class="badge" id="weekBadge">Semana: ‚Äî</div>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>Men√∫ generado</h2>
        <div class="menuText" id="menuBox">Cargando‚Ä¶</div>

        <div class="btnRow">
          <button id="btnGenerate">‚ö° Generar men√∫</button>
          <button id="btnRedoAll">üîÅ Rehacer TODO</button>
          <button id="btnRedoLM" class="ghost">‚Üª Rehacer Lunes-Martes</button>
          <button id="btnRedoMJ" class="ghost">‚Üª Rehacer Mi√©rcoles-Jueves</button>
          <button id="btnRedoV" class="ghost">‚Üª Rehacer Viernes</button>
        </div>

        <div class="btnRow">
          <button id="btnCopy" class="ghost">üìã Copiar</button>
          <a id="btnWhats" class="btn" target="_blank" rel="noopener">üí¨ Mandar por WhatsApp</a>
          <button id="btnDownload" class="ghost">‚¨áÔ∏è Descargar .txt</button>
          <button id="btnReset" class="danger">üßπ Olvidar men√∫ guardado</button>
        </div>

        <div class="small" id="status"></div>
      </section>

      <aside class="panel">
        <h2>Reglas activas</h2>
        <div class="list">
          <div class="pill">üîí Persistente por semana</div>
          <div class="pill">üóìÔ∏è Desde s√°bado: siguiente semana</div>
          <div class="pill">ü•© 1 prote√≠na</div>
          <div class="pill">ü•¶ 2 complementos</div>
          <div class="pill">üìå Rehacer por bloque</div>
          <p class="small">
            Nota: ‚ÄúGenerar men√∫‚Äù solo crea si a√∫n no existe para esa semana objetivo. Para cambiarlo usa ‚ÄúRehacer‚Ä¶‚Äù.
          </p>
        </div>
      </aside>
    </div>
  </div>
</div>

<script>
// =====================
//  LISTAS (tuyas)
// =====================
const PROTEINS = [
  // Pollo
  "Pollo asado",
  "Pollo a la plancha",
  "Pollo en salsa verde",
  "Pollo con salsa de soya y lim√≥n",
  "Pollo al grat√≠n con chorizo",
  "Pollo al grat√≠n",
  "Fajitas de pollo asadas",
  "Tinga de pollo",
  // Pechuga de pollo
  "Pechuga de pollo asada",
  "Pechuga de pollo a la plancha",
  "Pechuga de pollo encebollada",
  // Res
  "Entrecot",
  "Picadillo de res",
  "Alb√≥ndigas de res",
  "Salpic√≥n de res",
  // Cerdo
  "Cerdo en salsa verde",
  // Pescado / Mariscos
  "Salm√≥n asado",
  "Ceviche de at√∫n",
  "Medall√≥n de at√∫n",
  "At√∫n tipo bacalao",
  // Otras
  "Tortitas de papa con at√∫n",
  "Pastel de papa con queso y jam√≥n"
];

const SIDES = [
  // Sopas / Cremas
  "Sopa de fideo",
  "Sopa de verduras",
  "Sopa aguada",
  "Sopa de tortilla",
  "Crema de verdura",
  // Carbohidratos
  "Arroz",
  "Arroz integral",
  "Quinoa",
  "Spaghetti blanco",
  "Spaghetti al ajo",
  "Pasta",
  // Leguminosas
  "Lentejas",
  "Frijoles de la olla",
  "Alubias guisadas",
  // Papas
  "Papas asadas",
  "Papas al horno",
  "Pur√© de papa",
  // Verduras / Ensaladas
  "Ensalada verde",
  "Ensalada de lechuga",
  "Ensalada de lechuga con espinaca",
  "Ensalada de nopales",
  "Ensalada de jitomate",
  "Ensalada de jitomate con lechuga",
  "Verduras al vapor",
  "Verduras asadas",
  "Verduras salteadas",
  "Verduras crudas",
  "Ensalada con aguacate",
  "Ensalada verde con semillas",
  "Guacamole"
];

// =====================
//  CONFIG
// =====================
const STORAGE_KEY = "menu_week_blocks_v2";
const BLOCKS = [
  { key: "LM", title: "Lunes y Martes" },
  { key: "MJ", title: "Mi√©rcoles y Jueves" },
  { key: "V",  title: "Viernes" }
];

// =====================
//  DOM
// =====================
const els = {
  weekBadge: document.getElementById("weekBadge"),
  menuBox: document.getElementById("menuBox"),
  status: document.getElementById("status"),
  btnGenerate: document.getElementById("btnGenerate"),
  btnRedoAll: document.getElementById("btnRedoAll"),
  btnRedoLM: document.getElementById("btnRedoLM"),
  btnRedoMJ: document.getElementById("btnRedoMJ"),
  btnRedoV: document.getElementById("btnRedoV"),
  btnCopy: document.getElementById("btnCopy"),
  btnWhats: document.getElementById("btnWhats"),
  btnDownload: document.getElementById("btnDownload"),
  btnReset: document.getElementById("btnReset"),
};

// =====================
//  Utils
// =====================
function pad2(n){ return String(n).padStart(2,'0'); }

function isoWeekInfo(date = new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7; // 1..7
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return { year: d.getUTCFullYear(), week: weekNo };
}

// S√°bado = 6 (getDay: Dom=0..Sab=6). Regla: s√°bado ya permite generar "siguiente semana"
function targetWeekInfo(now = new Date()){
  const day = now.getDay();
  const base = new Date(now);
  if(day === 6){ // s√°bado
    base.setDate(base.getDate() + 7);
  }
  return isoWeekInfo(base);
}

function setStatus(msg, ok=false){
  els.status.textContent = msg;
  els.status.className = "small " + (ok ? "ok" : "");
}

function seededRng(seed){
  // LCG determin√≠stico
  let x = seed >>> 0;
  return function(){
    x = (1664525 * x + 1013904223) >>> 0;
    return x / 4294967296; // 0..1
  };
}

function pickOne(arr, rng){
  return arr[Math.floor(rng() * arr.length)];
}

function pickTwoDistinct(arr, rng){
  if(arr.length < 2) throw new Error("SIDES necesita >= 2 elementos");
  const a = pickOne(arr, rng);
  let b = pickOne(arr, rng);
  let guard = 0;
  while(b === a && guard++ < 20){
    b = pickOne(arr, rng);
  }
  if(a === b){
    // fallback s√∫per seguro
    const idxA = arr.indexOf(a);
    const idxB = (idxA + 1) % arr.length;
    b = arr[idxB];
  }
  return [a,b];
}

function comboToText(blockTitle, combo){
  return `${blockTitle}:\nüçó/ü•© ${combo.protein}\nü•¶ ${combo.sides[0]}\nü•¶ ${combo.sides[1]}\n`;
}

function formatMenuText(meta, data){
  const lines = [];
  lines.push(`MEN√ö ‚Äî Semana objetivo ISO ${meta.week} / ${meta.year}`);
  lines.push(`(Se mantiene fijo durante la semana. Desde s√°bado: ya puedes generar el de la siguiente.)`);
  lines.push("‚Äî".repeat(46));
  for(const b of BLOCKS){
    const c = data.blocks[b.key];
    if(c){
      lines.push(comboToText(b.title, c));
    }
  }
  return lines.join("\n").trim();
}

function render(meta, data){
  els.weekBadge.textContent = `Semana objetivo: ${meta.week} (${meta.year})`;
  const text = formatMenuText(meta, data);
  els.menuBox.textContent = text;
  els.btnWhats.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
}

// =====================
//  Storage
// =====================
function loadSaved(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}

function save(meta, blocks){
  const obj = { meta, blocks, at: Date.now() };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  return obj;
}

function isSameMeta(a,b){
  return a && b && a.week === b.week && a.year === b.year;
}

// =====================
//  Generator (por bloque)
// =====================
function makeSeed(meta, blockKey, extraSalt=0){
  // Seed estable por semana y bloque (si no hay extraSalt)
  const base = meta.year * 1000 + meta.week;
  const bk = blockKey.split("").reduce((s,ch)=>s+ch.charCodeAt(0),0);
  return (base * 31 + bk * 997 + extraSalt) >>> 0;
}

function generateBlock(meta, blockKey, extraSalt=0){
  const rng = seededRng(makeSeed(meta, blockKey, extraSalt));
  const protein = pickOne(PROTEINS, rng);
  const sides = pickTwoDistinct(SIDES, rng);
  return { protein, sides };
}

function generateAllBlocks(meta, extraSalt=0){
  const blocks = {};
  for(const b of BLOCKS){
    blocks[b.key] = generateBlock(meta, b.key, extraSalt);
  }
  return blocks;
}

// =====================
//  Logic: Semana objetivo + reglas
// =====================
function currentTargetMeta(){
  return targetWeekInfo(new Date());
}

function ensureMenuLoaded(){
  const meta = currentTargetMeta();
  const saved = loadSaved();

  if(saved && isSameMeta(saved.meta, meta) && saved.blocks){
    render(meta, saved);
    setStatus("Cargado men√∫ guardado para la semana objetivo.", true);
    return;
  }

  // No existe para la semana objetivo: mostrar estado y esperar bot√≥n "Generar"
  render(meta, { blocks: {} });
  els.menuBox.textContent =
    `No hay men√∫ guardado para la semana objetivo (${meta.week}/${meta.year}).\n` +
    `Pulsa "Generar men√∫" para crearlo.\n\n` +
    `Regla: de lunes a viernes, una vez creado se mantiene. En s√°bado ya genera para la siguiente semana.`;
  setStatus("Listo para generar men√∫ nuevo.", false);
}

// =====================
//  Actions
// =====================
function canGenerateNewForTargetWeek(){
  const meta = currentTargetMeta();
  const saved = loadSaved();
  return !(saved && isSameMeta(saved.meta, meta) && saved.blocks && Object.keys(saved.blocks).length);
}

function actionGenerateIfEmpty(){
  const meta = currentTargetMeta();
  const saved = loadSaved();

  if(saved && isSameMeta(saved.meta, meta) && saved.blocks && Object.keys(saved.blocks).length){
    render(meta, saved);
    setStatus("Ya existe un men√∫ para esta semana objetivo. Usa 'Rehacer...' si quieres cambiarlo.", false);
    return;
  }

  const blocks = generateAllBlocks(meta, /*extraSalt*/ 0);
  const obj = save(meta, blocks);
  render(meta, obj);
  setStatus("Men√∫ generado y guardado ‚úÖ", true);
}

function actionRedoAll(){
  const meta = currentTargetMeta();
  const saved = loadSaved();
  const prevSalt = (saved && isSameMeta(saved.meta, meta) && saved.at) ? saved.at : Date.now();
  // extraSalt cambia el resultado aunque sea misma semana
  const blocks = generateAllBlocks(meta, prevSalt & 0xffffffff);
  const obj = save(meta, blocks);
  render(meta, obj);
  setStatus("Men√∫ COMPLETO rehecho y guardado ‚úÖ", true);
}

function actionRedoBlock(blockKey){
  const meta = currentTargetMeta();
  const saved = loadSaved();

  // si no hay saved para semana objetivo, primero creamos el resto base para no quedar incompleto
  let blocks = (saved && isSameMeta(saved.meta, meta) && saved.blocks) ? {...saved.blocks} : generateAllBlocks(meta, 0);

  const salt = Date.now() & 0xffffffff;
  blocks[blockKey] = generateBlock(meta, blockKey, salt);

  const obj = save(meta, blocks);
  render(meta, obj);

  const title = BLOCKS.find(b => b.key === blockKey)?.title || blockKey;
  setStatus(`Bloque "${title}" rehecho y guardado ‚úÖ`, true);
}

async function copyToClipboard(){
  const text = els.menuBox.textContent || "";
  try{
    await navigator.clipboard.writeText(text);
    setStatus("Copiado al portapapeles ‚úÖ", true);
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    setStatus("Copiado (modo compatibilidad) ‚úÖ", true);
  }
}

function downloadTxt(){
  const text = els.menuBox.textContent || "";
  const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const meta = currentTargetMeta();
  const a = document.createElement("a");
  a.href = url;
  a.download = `menu-${meta.year}-W${pad2(meta.week)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  setStatus("Archivo .txt descargado ‚úÖ", true);
}

function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  setStatus("Men√∫ guardado eliminado. Puedes generar uno nuevo.", true);
  ensureMenuLoaded();
}

// =====================
//  Wire events
// =====================
els.btnGenerate.addEventListener("click", actionGenerateIfEmpty);
els.btnRedoAll.addEventListener("click", actionRedoAll);
els.btnRedoLM.addEventListener("click", () => actionRedoBlock("LM"));
els.btnRedoMJ.addEventListener("click", () => actionRedoBlock("MJ"));
els.btnRedoV.addEventListener("click",  () => actionRedoBlock("V"));
els.btnCopy.addEventListener("click", copyToClipboard);
els.btnDownload.addEventListener("click", downloadTxt);
els.btnReset.addEventListener("click", resetAll);

// =====================
//  Init
// =====================
ensureMenuLoaded();
</script>
</body>
</html>
